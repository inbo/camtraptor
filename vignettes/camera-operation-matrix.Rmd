---
title: "Camera operation matrix"
author: "Damiano Oldoni"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Camera operation matrix}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignette shows how to get a *camera trap station operability matrix*, shortly called *camera operation matrix* as returned by camtrapR's function [cameraOperation](https://jniedballa.github.io/camtrapR/reference/cameraOperation.html).

## Setup

Load packages:

```{r load_pkgs}
library(camtraptor)
library(lubridate)
```

We can load a camera trap data package, `x`:

```{r load_dataset}
x <- example_dataset()
```

It contains camera trap data about musk rat and coypu. We will use this variable from now on.


## Camera operation matrix

You can create a camera operation matrix by passing a camera trap data package:

```{r basic_usage}
camtrapR_cameraOperation(x)
```

The function will read the `deployments` slot of the data package to create the matrix.

The matrix rows are the location names, by default the values of field `locationName` of `deployments`. Column names are dates. The matrix values are: 0 if station is not active, an integer (1 or more) if one or more deployments linked to the same station are fully active during the whole day and a decimal value for partially active stations.

In the example above there was a one-to-one relation between deployments and locations: the daily effort is between 0 and 1.

In the example below we show what happens if all four deployments are set to the same location (`B_DL_val 5_beek kleine vijver`) and they are active during the same days:

```{r four_deploys_same_start_end_for_one_location}
x1 <- x
x1$data$deployments$locationName <- deployments(x1) %>% 
  purrr::pluck("locationName", 1)
x1$data$deployments$start <- deployments(x1) %>% 
  purrr::pluck("deploymentStart", 1)
x1$data$deployments$end <- deployments(x1) %>% purrr::pluck("deploymentEnd", 1)
multiple_deploys_matrix <- camtrapR_cameraOperation(x1)
multiple_deploys_matrix
```

In the example below we simulate a location (`B_DM_val 4_'t WAD`) linked to two deployments active in two different periods:

```{r two_deploys_two_periods}
x2 <- x
x2$data$deployments$locationName[4] <- deployments(x2) %>% 
  purrr::pluck("locationName", 3)
x2$data$deployments$deploymentStart[4] <- deployments(x2) %>% 
  purrr::pluck("deploymentEnd", 3) + ddays(5)
x2$data$deployments$deploymentEnd[4] <- deployments(x2) %>% 
  purrr::pluck("deploymentStart", 4) + ddays(5)
deployments(x2) %>% dplyr::select(locationName, deploymentStart, deploymentEnd)
```

This results in the following camera operation matrix:

```{r camOp_two_deploys_two_periods}
two_deploys_two_periods_matrix <- camtrapR_cameraOperation(x2)
days_to_show <- seq(as.Date(deployments(x2)$deploymentStart[3]),
                    as.Date(deployments(x2)$deploymentEnd[4]),
                    by = "days"
)
two_deploys_two_periods_matrix[3,as.character(days_to_show)]
```

### Station names

You can specify the column containing the station names instead of using the default `locationName`. In the example below we use the column `locationID`. A small preview of the matrix is shown:

```{r cam_op_with_locationID}
cam_op_with_locationID <- camtrapR_cameraOperation(
  x,
  station_col = "locationID"
)
cam_op_with_locationID[1:4, 1:2]
```

You can also decide to use prefix `"Station"` in the station names as done by camtrapR's `cameraOperation()` by setting `use_prefix = TRUE`. A small preview of the entire matrix is shown:

```{r use_prefix}
cam_op_with_prefix <- camtrapR_cameraOperation(x, use_prefix = TRUE)
cam_op_with_prefix[1:4,1:2]
```

### Session and camera IDs

You can specify the column containing the camera IDs to be added to the station names following the camtrapR's convention: `Station__CAM_CameraID`. Only the row names are shown:

```{r add_camera_IDs}
x_cameras <- x
x_cameras$data$deployments$cameraID <- c(1, 2, 3, 4)
cam_op_with_camera_ids <- camtrapR_cameraOperation(
  x_cameras,
  camera_col = "cameraID"
)
row.names(cam_op_with_camera_ids)
```

You cans also add the session IDs using `session_col` argument, following the camtrapR's convention: `Station__SESS_sessionID`:

```{r add_session_IDs}
x_sessions <- x
x_sessions$data$deployments$session <- c(1, 2, 3, 4)
cam_op_with_session_ids <- camtrapR_cameraOperation(x_sessions, session_col = "session")
row.names(cam_op_with_session_ids)
```

To use both camera and session IDs, the camtrapR's convention `Station__SESS_SessionID__CAM_CameraID` is followed:

```{r add_session_camera_IDs}
x_sessions$data$deployments$cameraID <- c(1, 2, 3, 4)
cam_op_with_session_and_camera_ids <- camtrapR_cameraOperation(
  x_sessions, 
  camera_col = "cameraID",
  session_col = "session"
)
row.names(cam_op_with_session_and_camera_ids)
```
